extends ../wrapper

block seo
	- var posts = [data.post]
	- var profile = data.profile
	
	- var body = posts[0].body ? marked(posts[0].body) : ''
	- var title = 'Story by ' + posts[0].resolvedProfiles[posts[0].source].profile.name
	
	if body.match(/^\<h\d[^\>]*\>([^\<]*)/)
		- title= body.match(/^\<h\d[^\>]*\>([^\<]*)/)[0]
		- body= body.replace(/^\<h\d[^\>]*\>([^\<]*)/,'')
		- title= title.replace(/<.*?>/g,"")
		
	- summary = body.replace(/<.*?>/g,"")
	- summary = summary.replace(/[\n]/g,"")

	if summary.length > 200
		- summary= summary.substring(0,200)
		- summary= summary.replace(/[^ ]+$/,'')  + '...'
	
	- var image = profile.background.url;
	if _.has(posts[0],'sortedPhotos[0]')
		if posts[0].sortedPhotos.length > 1
			- summary += ' (' + posts[0].sortedPhotos.length + ' photos)'

		- var imageSet
		if typeof posts[0].sortedPhotos[0].uploads === 'function'
			- imageSet= posts[0].sortedPhotos[0].uploads()[0].imageSet
		else
			- imageSet= posts[0].sortedPhotos[0].uploads[0].imageSet
		if imageSet.large 
			- image = imageSet.large.url
		else
			- image = imageSet.original.url
	else
		- var matches = body.match(/<div class="ogPreview" data-jsclass="OgTagPreview" data-src="\/api\/OgTags\/scrape" data-url="([^"]+)" data-type="json"><\/div>/)
		if matches
			- image = config.publicHost + '/linked-og-image?url=' + encodeURIComponent(matches[1])
			
	title= title
	meta(property="og:type" content="article")
	meta(property="og:image" content= image)
	meta(property="og:title" content= title)
	meta(property="og:description" content= summary)

block content
	include profile-hero
	
	.profile-parallax(data-jsclass="vibrantController" data-image= profile.backgroundSmall.url)
		include profile-tabs

		.container-fluid.content-padding-top.content.no-gutters
			.row
				.col-sm-8.left-column
					include ../components/post-list
				.col-sm-4
					if user
						#newsfeed-here
					else
						include ../components/server-sidebar
